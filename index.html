<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>불법주정차 민원 히트맵 · 요일·시간 필터 (v-time-filter+debug)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body { height:100%; margin:0; }
    #map { height:100vh; }
    .controls {
      position: absolute; z-index: 1000; left: 8px; top: 8px;
      background: rgba(255,255,255,.95); padding: 8px 10px; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,.15); font-size: 13px; line-height: 1.4;
    }
    .controls label { margin-right: 6px; }
    .hud {
      position: absolute; z-index: 1000; left: 8px; bottom: 8px;
      background: rgba(0,0,0,.6); color: #fff; padding: 6px 8px; border-radius: 6px;
      font-size: 12px; line-height: 1.4; max-width: 70vw;
    }
    .badge {
      position: absolute; z-index: 1000; right: 8px; top: 8px;
      background: #111; color:#fff; padding:4px 8px; border-radius: 6px; font-size: 12px;
      opacity: .85;
    }
    .warn {
      position:absolute; z-index:1000; left:8px; top:64px;
      background: rgba(255,230,150,.95); padding:6px 8px; border-radius:6px; font-size:12px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      display:none;
    }
    .status {
      position:absolute; z-index:1000; right:8px; top:44px;
      background: rgba(255,255,255,.95); padding:6px 8px; border-radius:6px; font-size:12px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- 상단: 요일·시간 필터 -->
  <div class="controls">
    <label>요일
      <select id="dowSel">
        <option value="all">전체</option>
        <option value="0">월</option>
        <option value="1">화</option>
        <option value="2">수</option>
        <option value="3">목</option>
        <option value="4">금</option>
        <option value="5">토</option>
        <option value="6">일</option>
      </select>
    </label>
    <label style="margin-left:8px;">시간
      <input id="hourRange" type="range" min="0" max="23" step="1" value="9" />
      <span id="hourLabel">09시</span>
      <label style="margin-left:6px;">
        <input id="allHours" type="checkbox" />
        전체시간
      </label>
    </label>
  </div>

  <!-- 배지/경고/상태 -->
  <div class="badge">v-time-filter+debug</div>
  <div class="warn" id="warn">⚠ CSV에서 ‘일시’ 열을 찾지 못했습니다. 열 이름을 ‘단속일시/발생일시/신고일시/일시/Date/datetime’ 중 하나로 바꾸면 요일·시간 필터가 활성화됩니다.</div>
  <div class="status" id="status">로드 준비…</div>

  <!-- 좌하단: 위치 HUD -->
  <div class="hud" id="hud">GPS 대기중…</div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // ───────── 0) 지도
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    map.setView([36.64, 127.49], 12);

    const dowSel = document.getElementById('dowSel');
    const hourRange = document.getElementById('hourRange');
    const hourLabel = document.getElementById('hourLabel');
    const allHoursChk = document.getElementById('allHours');
    const warnBox = document.getElementById('warn');
    const statusBox = document.getElementById('status');

    // ───────── 1) CSV 후보 경로
    const rawCandidates = [
      '지오코딩결과_전체 (1).csv',
      '지오코딩결과_전체.csv',
      'geocoded.csv',
      'data/geocoded.csv'
    ];
    const candidates = rawCandidates.map(p => {
      let pth = location.pathname; if (!pth.endsWith('/')) pth = pth.replace(/\/[^/]*$/, '/');
      return location.origin + pth + encodeURI(p) + '?v=' + Date.now();
    });

    // ───────── 2) 컬럼 탐지/날짜 파서
    const LAT_KEYS = ['위도','lat','latitude','Lat','Latitude','Y','y'];
    const LON_KEYS = ['경도','lon','longitude','Lon','Longitude','X','x'];
    const DATE_KEYS = ['단속일시','발생일시','신고일시','일시','date','Date','datetime','Datetime'];

    function findKey(keys, header) {
      const lower = header.map(h => (h||'').toString().trim().toLowerCase());
      // 완전일치 먼저
      for (const k of keys) {
        const i = lower.indexOf(k.toLowerCase()); if (i !== -1) return header[i];
      }
      // 부분일치(괄호/공백 붙은 경우)
      for (const h of header) {
        const L = (h||'').toString().trim().toLowerCase();
        for (const k of keys) if (L.includes(k.toLowerCase())) return h;
      }
      return null;
    }
    function toNum(v){ if (typeof v==='number') return v; if (v==null) return NaN; const s=v.toString().trim().replace(/[, ]/g,''); return s?Number(s):NaN; }

    // 한국식/AMPM/구분자 다양한 날짜 파서
    function parseDateLoose(val){
      if(!val) return null; let s=String(val).trim();
      const hasPM=/오후|PM/i.test(s), hasAM=/오전|AM/i.test(s);
      s=s.replace(/[./]/g,'-').replace(/[오전오후AMPMapm]/g,'').trim(); // 텍스트 제거
      const nums=s.match(/\d+/g); if(!nums||nums.length<3){ const d=new Date(val); return isNaN(d)?null:d; }
      let [Y,M,D,h=0,m=0,s2=0]=nums.map(n=>parseInt(n,10));
      if (hasPM && h<12) h+=12; if (hasAM && h===12) h=0;
      const d=new Date(Y,(M||1)-1,D||1,h,m,s2); return isNaN(d)?null:d;
    }
    function getMon0Dow(d){ return (d.getDay()+6)%7; } // Mon=0..Sun=6
    function pad2(n){ return (n<10?'0':'')+n; }

    // ───────── 3) 데이터 적재
    let heatLayer=null; const pointsByHOW=Array.from({length:168},()=>[]); let allPoints=[];
    async function loadCSV(){
      for(const url of candidates){
        try{
          statusBox.textContent='CSV 로드 중: '+decodeURI(url);
          const res=await new Promise((resolve,reject)=>{ Papa.parse(url,{header:true,download:true,skipEmptyLines:true,complete:resolve,error:reject}); });
          if(!res||!res.data||res.data.length===0) continue;

          const header=res.meta&&res.meta.fields?res.meta.fields:Object.keys(res.data[0]||{});
          const latKey=findKey(LAT_KEYS,header);
          const lonKey=findKey(LON_KEYS,header);
          const dateKey=findKey(DATE_KEYS,header);
          statusBox.textContent=`컬럼 인식 → 위도: ${latKey||'-'}, 경도: ${lonKey||'-'}, 일시: ${dateKey||'-'}`;

          if(!latKey||!lonKey){ console.warn('위경도 미인식', header); continue; }

          for(let i=0;i<168;i++) pointsByHOW[i]=[];
          allPoints=[];

          let valid=0, dated=0;
          for(const row of res.data){
            const lat=toNum(row[latKey]), lon=toNum(row[lonKey]);
            if(!Number.isFinite(lat)||!Number.isFinite(lon)||Math.abs(lat)>90||Math.abs(lon)>180) continue;
            allPoints.push([lat,lon,1]); valid++;
            if(dateKey && row[dateKey]){
              const d=parseDateLoose(row[dateKey]);
              if(d){ const how=getMon0Dow(d)*24+d.getHours(); pointsByHOW[how].push([lat,lon,1]); dated++; }
            }
          }

          // 날짜 열 유무에 따라 안내/컨트롤 상태
          if(dated===0){ warnBox.style.display='block'; allHoursChk.checked=true; dowSel.disabled=true; hourRange.disabled=true; }
          else { warnBox.style.display='none'; dowSel.disabled=false; hourRange.disabled=false; allHoursChk.checked=false; }

          renderHeat(dowSel.value, hourRange.value);
          console.log('CSV OK', {records:valid, withDatetime:dated, latKey, lonKey, dateKey});
          return;
        }catch(e){ console.warn('CSV 로드 실패:', url, e); }
      }
      statusBox.textContent='CSV를 찾지 못했습니다.';
      alert('CSV를 찾지 못했거나, 위도/경도 컬럼을 인식하지 못했습니다.\n파일명을 "지오코딩결과_전체 (1).csv" 또는 "geocoded.csv"로 업로드했는지 확인하세요.');
    }

    // ───────── 4) 히트맵 그리기
    function renderHeat(dowValue, hourValue){
      let pts=[];
      if(allHoursChk.checked || dowValue==='all'){ pts=allPoints; }
      else{
        const how=parseInt(dowValue,10)*24 + parseInt(hourValue,10);
        pts=pointsByHOW[how]||[];
      }
      if(heatLayer) map.removeLayer(heatLayer);
      if(pts.length>0){
        heatLayer=L.heatLayer(pts,{radius:18,blur:15,maxZoom:18}).addTo(map);
        const bounds=L.latLngBounds(pts.map(p=>L.latLng(p[0],p[1])));
        map.fitBounds(bounds,{padding:[20,20]});
        statusBox.textContent=`표시 포인트: ${pts.length}개`;
      }else{
        statusBox.textContent='선택 조건에 해당하는 포인트가 없습니다.';
      }
    }

    // UI 이벤트
    function updateHourLabel(){ hourLabel.textContent=pad2(parseInt(hourRange.value,10))+'시'; }
    dowSel.addEventListener('change', ()=>renderHeat(dowSel.value, hourRange.value));
    hourRange.addEventListener('input', ()=>{ updateHourLabel(); renderHeat(dowSel.value, hourRange.value); });
    allHoursChk.addEventListener('change', ()=>renderHeat(dowSel.value, hourRange.value));

    // ───────── 5) 내 위치 지속 추적
    const hud=document.getElementById('hud'); let myMarker=null, accCircle=null;
    function updateMyLocation(lat,lon,acc,speed){
      const latlng=[lat,lon];
      if(!myMarker) myMarker=L.marker(latlng).addTo(map).bindPopup('내 위치'); else myMarker.setLatLng(latlng);
      if(!accCircle) accCircle=L.circle(latlng,{radius:acc||10,weight:1,fillOpacity:.15}).addTo(map);
      else { accCircle.setLatLng(latlng); accCircle.setRadius(acc||10); }
      map.setView(latlng, Math.max(map.getZoom(),15));
      const accStr=(acc!=null)?`${Math.round(acc)} m`:'-';
      const spd=(speed!=null && !Number.isNaN(speed))?(speed*3.6):null;
      hud.textContent=`내 위치: ${lat.toFixed(6)}, ${lon.toFixed(6)} | 정확도: ${accStr}` + (spd!=null?` | 속도: ${spd.toFixed(1)} km/h`:``);
    }
    function handleGeoError(err){ console.warn('Geolocation error:',err); hud.textContent=`GPS 오류: ${err.message}`; }
    function startWatch(){
      if(!('geolocation' in navigator)){ hud.textContent='이 브라우저는 위치 서비스를 지원하지 않습니다.'; return; }
      navigator.geolocation.watchPosition(
        pos => { const {latitude,longitude,accuracy,speed}=pos.coords; updateMyLocation(latitude,longitude,accuracy,speed); },
        handleGeoError,
        { enableHighAccuracy:true, maximumAge:0, timeout:10000 }
      );
    }

    // ───────── 6) 시작
    updateHourLabel();
    loadCSV();
    startWatch();
  </script>
</body>
</html>
